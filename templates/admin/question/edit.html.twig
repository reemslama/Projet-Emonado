{% extends 'base_admin.html.twig' %}

{% block title %}Modifier Question{% endblock %}

{% block header %}Modifier la Question{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-pencil-square me-2"></i> Modifier la question
                    </h4>
                    <a href="{{ path('admin_dashboard') }}#questions" class="btn btn-sm btn-outline-light">
                        <i class="bi bi-arrow-left me-1"></i> Retour
                    </a>
                </div>

                <div class="card-body p-4">
                    {{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}

                    <!-- Texte de la question -->
                    <div class="mb-4">
                        {{ form_label(form.texte, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                        {{ form_widget(form.texte, {
                            'attr': {
                                'class': 'form-control form-control-lg',
                                'placeholder': 'Entrez la question ici...',
                                'rows': 3
                            }
                        }) }}
                        {{ form_errors(form.texte) }}
                    </div>

                    <!-- Catégorie / Ordre / Type -->
                    <div class="row mb-4 g-3">
                        <div class="col-md-5">
                            {{ form_label(form.categorie, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                            {{ form_widget(form.categorie, {'attr': {'class': 'form-select form-select-lg'}}) }}
                            {{ form_errors(form.categorie) }}
                        </div>
                        <div class="col-md-3">
                            {{ form_label(form.ordre, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                            {{ form_widget(form.ordre, {
                                'attr': {
                                    'class': 'form-control form-control-lg',
                                    'min': '1'
                                }
                            }) }}
                            {{ form_errors(form.ordre) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.typeQuestion, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                            {{ form_widget(form.typeQuestion, {'attr': {'class': 'form-select form-select-lg'}}) }}
                            {{ form_errors(form.typeQuestion) }}
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Bloc Réponses simplifié -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="bi bi-list-check me-2"></i>Réponses possibles
                                <small class="text-muted ms-2">({{ question.reponses|length }})</small>
                            </h5>
                            <button type="button" class="btn btn-sm btn-success add-another-response">
                                <i class="bi bi-plus-lg"></i> Ajouter une réponse
                            </button>
                        </div>

                        <div id="reponses-collection-holder"
                             data-prototype="{{ form_widget(form.reponses.vars.prototype)|e }}"
                             data-widget-counter="{{ form.reponses|length }}">

                            {% for reponseForm in form.reponses %}
                                <div class="reponse-row d-flex gap-3 align-items-center mb-2 position-relative">
                                    {{ form_widget(reponseForm.texte, {
                                        'attr': {
                                            'placeholder': 'Réponse (ex: Jamais, Parfois, Souvent...)',
                                            'class': 'form-control flex-grow-1'
                                        }
                                    }) }}

                                    {{ form_widget(reponseForm.valeur, {
                                        'attr': {
                                            'placeholder': 'Score',
                                            'class': 'form-control text-center',
                                            'style': 'max-width: 100px;'
                                        }
                                    }) }}

                                    <button type="button" class="btn btn-sm btn-outline-danger delete-response">
                                        <i class="bi bi-x-lg"></i>
                                    </button>

                                    {{ form_errors(reponseForm) }}
                                </div>
                            {% endfor %}
                        </div>

                        {% if form.reponses.vars.errors|length > 0 %}
                            <div class="alert alert-danger mt-2">
                                {{ form_errors(form.reponses) }}
                            </div>
                        {% endif %}
                    </div>

                    {{ form_rest(form) }}

                    <div class="d-flex justify-content-between mt-5 pt-4 border-top">
                        <a href="{{ path('admin_dashboard') }}#questions"
                           class="btn btn-outline-secondary btn-lg px-4">
                            <i class="bi bi-arrow-left me-2"></i>Retour au tableau
                        </a>

                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="bi bi-save me-2"></i> Enregistrer les modifications
                        </button>
                    </div>

                    {{ form_end(form) }}
                </div>
            </div>

            <!-- Carte d'aide -->
            <div class="card mt-4 border-info">
                <div class="card-body">
                    <h6 class="text-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>Conseils rapides
                    </h6>
                    <ul class="small mb-0 text-muted">
                        <li>Score positif = réponse favorable / négatif = défavorable</li>
                        <li>Exemples de scores : -2, -1, 0, +1, +2</li>
                        <li>4 à 6 réponses suffisent généralement pour un bon questionnaire</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const holder = document.getElementById('reponses-collection-holder');
            if (!holder) return;

            let index = parseInt(holder.dataset.widgetCounter, 10) || 0;

            // Ajouter une nouvelle réponse
            document.querySelector('.add-another-response')?.addEventListener('click', (e) => {
                e.preventDefault();

                const proto = holder.dataset.prototype;
                if (!proto) return;

                const html = proto.replace(/__name__(label)?__/g, index);
                const div = document.createElement('div');
                div.innerHTML = html;

                const row = div.firstElementChild;
                row.className = 'reponse-row d-flex gap-3 align-items-center mb-2 position-relative';

                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'btn btn-sm btn-outline-danger delete-response';
                delBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
                row.appendChild(delBtn);

                holder.appendChild(row);
                index++;

                delBtn.addEventListener('click', () => row.remove());
            });

            // Supprimer une réponse (existante ou nouvelle)
            holder.addEventListener('click', (e) => {
                if (e.target.closest('.delete-response')) {
                    e.preventDefault();
                    e.target.closest('.reponse-row')?.remove();
                }
            });
        });
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .reponse-row {
            background: #f9f9f9;
            border-radius: 6px;
            padding: 8px 12px;
            transition: all 0.15s;
        }
        .reponse-row:hover {
            background: #f0f4ff;
        }
        .reponse-row .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13,110,253,.15);
        }
        .delete-response {
            padding: 0.35rem 0.65rem;
            font-size: 0.95rem;
        }
    </style>
{% endblock %}