{% extends 'base.html.twig' %}

{% block body %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Liste des Rendez-vous</h2>
        <a href="{{ path('app_rendez_vous_new') }}" class="btn btn-primary">Nouveau</a>
    </div>

    {# Formulaire de recherche #}
    <form method="get" class="row g-2 mb-4">
        <div class="col-md-4">
            <input type="text" name="q" class="form-control shadow-sm" 
                   placeholder="Rechercher nom ou CIN..." 
                   value="{{ app.request.query.get('q') }}">
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-dark shadow-sm">Filtrer</button>
            <a href="{{ path('app_rendez_vous_index') }}" class="btn btn-outline-secondary shadow-sm">Réinitialiser</a>
        </div>
    </form>

    <div class="card shadow-sm border-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>
                        <a href="{{ path('app_rendez_vous_index', {sort: 'nom', q: app.request.query.get('q')}) }}" 
                           class="text-decoration-none text-dark">
                            Patient ↑↓
                        </a>
                    </th>
                    <th>CIN</th>
                    <th>Psychologue</th>
                    <th>Type</th>
                    <th>
                        <a href="{{ path('app_rendez_vous_index', {sort: 'date', q: app.request.query.get('q')}) }}" 
                           class="text-decoration-none text-dark">
                            Date ↑↓
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {# ✅ CORRECTION: utilisation de 'rendez_vous' au lieu de 'rendezvous' #}
                {% for r in rendez_vous %}
                    <tr>
                        <td class="fw-bold text-primary">{{ r.nomPatient|upper }}</td>
                        <td><code>{{ r.cin }}</code></td>
                        <td>Dr. {{ r.nomPsychologue }}</td>
                        <td>
                            <span class="badge" 
                                  style="background-color: {{ r.type ? r.type.couleur|default('#0d6efd') : '#0d6efd' }}; color: white;">
                                {{ r.type ? r.type.libelle : 'Non défini' }}
                            </span>
                        </td>
                        <td>{{ r.date ? r.date|date('d/m/Y H:i') : '' }}</td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted fst-italic">
                            Aucun résultat trouvé.
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}